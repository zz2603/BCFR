---
title: "data merging and cleaning"
author: "Ziyi Zhao"
date: "3/16/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)

```

The purpose of this code file is to gather all related information from each spreadsheet.

# Import dataset

All spreadsheets in xlsx dataset are converted into csv file separately, and each csv file is named with the name of spreadsheet.

```{r include=FALSE}
## import dataset 'family membership.csv'
fam_mem <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/family_membership.csv") %>% 
  janitor::clean_names()

## import dataset 'bc_epi.csv'
bc_epi <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/bc_epi.csv") %>% 
  janitor::clean_names()

## import dataset 'individual.csv'
indvd <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/individual.csv") %>% 
  janitor::clean_names()

## import dataset 'nutrient.csv'
nutrnt <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/nutrient.csv") %>% 
  janitor::clean_names()

## import dataset 'bc_rx.csv'
bc_rx <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/bc_rx.csv") %>% 
  janitor::clean_names()

## import dataset 'bc_surgery.csv'
bc_surgry <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/bc_surgery.csv") %>% 
  janitor::clean_names()

## import dataset 'bc_mutation.csv'
bc_mutat <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/bc_mutation.csv") %>% 
  janitor::clean_names()

## import dataset 'bc_epi_status.csv'
bc_epi_stat <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/bc_epi_status.csv") %>% 
  janitor::clean_names()

## import dataset 'pregnancy.csv'
pregncy <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/pregnancy.csv") %>% 
  janitor::clean_names()

## import dataset 'cancer.csv'
cancer <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/cancer.csv") %>% 
  janitor::clean_names()

## import dataset 'family.csv'
famly <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/family.csv") %>% 
  janitor::clean_names()

## import dataset 'derived_var.csv'
derived_var <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/derived_var.csv") %>% 
  janitor::clean_names()

## import dataset 'bc_invasive.csv'
bc_invas <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/bc_invasive.csv") %>% 
  janitor::clean_names()

## import dataset 'bc_confirmation.csv'
bc_confirm <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/bc_confirmation.csv") %>% 
  janitor::clean_names()

## import dataset 'Hawaii_diet.csv'
hawaii_dt <- read_csv("C:/Users/zzhao/Desktop/BCFR/data/Hawaii_diet.csv") %>% 
  janitor::clean_names()

```

# merging and cleaning dataset

There are `r dim(bc_epi)[1]` unique rows (subjects) in total. However, not all datasets have unique subjects or contain all subjects. The first step is to select important variable from these datasets, such as follow-up, nutrient, other confounding covariates.

## Merge the dataset without tumor id.

```{r include=FALSE}
## build a new dataset by binding fam_mem and bc_epi
bc_data <- left_join(fam_mem,bc_epi,by="new_id") %>% 
  select(-c(center_no.y,aus_education))

## the name of center number is changes due to previous merging
## rename the center number
colnames(bc_data)[2] <- "center_no"

## merge bc_data with indvd and create a new table bc_data1
bc_data1 <- left_join(bc_data,indvd,by="new_id") %>% 
  select(-c(center_no.y,diet_q_aus))
colnames(bc_data1)[2] <- "center_no"

## merge bc_data1 with bc_mutation and create a new table bc_data2
bc_data2 <- left_join(bc_data1,bc_mutat,by="new_id") %>% 
  select(-center_no.y)
colnames(bc_data2)[2] <- "center_no"

## merge bc_data2 with bc_rx and create a new table bc_data3
bc_data3 <- left_join(bc_data2,bc_rx,by="new_id") %>% 
  select(-center_no.y)
colnames(bc_data3)[2] <- "center_no"

## merge bc_data3 with derived_var and create a new table bc_data4
bc_data4 <- left_join(bc_data3,derived_var,by="new_id") %>% 
  select(-center_no.y)
colnames(bc_data4)[2] <- "center_no"

## merge bc_data4 with famly and create a new table bc_data5
bc_data5 <- left_join(bc_data4,famly,by="family_id") %>% 
  select(-center_no.y)
colnames(bc_data5)[2] <- "center_no"

## before merging bc_data5 with nutrnt, select variables for MDS and aMED
## create a new table mds_nutrnt
## merge bc_data5 with mds_nutrnt and create a new table bc_data6
mds_nutrnt <- select(nutrnt,c(new_id,calories_in_food,
                              satur_fat_in_food,monounsat_fat_in_food,
                              food_group_veg_exc_legumes,
                              food_group_potatoes_tubers,
                              total_grain,whole_grain,
                              food_group_all_fruits_inc_juice,
                              food_group_fruit_juice_only,
                              total_fruit,
                              food_group_nuts,
                              food_group_all_dairy,
                              alcohol_in_food,
                              food_group_redmeat_nonprocessed,
                              food_group_processed_redmeat,
                              food_group_poultry,
                              food_group_processed_poultry,
                              food_group_legumes,
                              fish_only))
bc_data6 <- left_join(bc_data5,mds_nutrnt,by="new_id")

```

Since subjects can have more than one tumors, they may cause duplicated rows. It would be very messy if we merge datasets with duplicated rows. We can exclude some rows that we don't need in the study.

## Excluding patients from centers in Australia

```{r echo=FALSE}
## create a new dataset without Australian centers
bc_data_exc_aus <- bc_data6 %>% 
  filter(center_no %in% c(1,2,3,5,6))

bc_data_exc_aus %>% group_by(center_no) %>% 
  summarize(freq = n()) %>% 
  knitr::kable() ## generate a table frequency for each center

```

The table above showed the distribution of patients after we exclude the patient from Australia.

## Exclude participants who did not complete questionnaires

```{r echo=FALSE}
# Extract id and variables of questionnaires and nutrients
# view the distribution of subjects who complete epi questionnaires
bc_data_exc_aus %>% select(new_id,epi_q_breast,diet_q_hi,
                           calories_in_food,
                           satur_fat_in_food,monounsat_fat_in_food,
                           food_group_veg_exc_legumes,
                           food_group_potatoes_tubers,
                           total_grain,whole_grain,
                           food_group_all_fruits_inc_juice,
                           food_group_fruit_juice_only,
                           total_fruit,
                           food_group_nuts,
                           food_group_all_dairy,
                           alcohol_in_food,
                           food_group_redmeat_nonprocessed,
                           food_group_processed_redmeat,
                           food_group_poultry,
                           food_group_processed_poultry,
                           food_group_legumes,
                           fish_only) %>% 
  group_by(epi_q_breast) %>% 
  summarize(n=n())

```

Based on the table, there are 18160 subjects with "3". "3" was denotes as subject who completed epi questionnaires personally. No one should be excluded.

```{r echo=FALSE}
# view the distribution of subjects who complete hawaii diet questionnaires
bc_data_exc_aus %>% select(new_id,epi_q_breast,diet_q_hi,
                           calories_in_food,
                           satur_fat_in_food,monounsat_fat_in_food,
                           food_group_veg_exc_legumes,
                           food_group_potatoes_tubers,
                           total_grain,whole_grain,
                           food_group_all_fruits_inc_juice,
                           food_group_fruit_juice_only,
                           total_fruit,
                           food_group_nuts,
                           food_group_all_dairy,
                           alcohol_in_food,
                           food_group_redmeat_nonprocessed,
                           food_group_processed_redmeat,
                           food_group_poultry,
                           food_group_processed_poultry,
                           food_group_legumes,
                           fish_only) %>% 
  group_by(diet_q_hi) %>% 
  summarize(n=n())

```

* "0" was denoted as subjects who are not applicable. There are 935 subjects who are not applicable. They should be excluded.

* "1" was denoted as subjects who need questionnaire but were not requested yet. There are 2 of them. They should be exluded.

* "2" was denoted as subjects who has pending, requested questionnaires. There are 493 of them. They should be exluded.

* "3" was denoted as subjects who complete questionnaire personally and their responses were received. There are 12,613 of them. They should be kept in our study.

* "5" was denoted as subjects who refused to complete questionnaires. There are 711 of them. They should be excluded.

* "6" was denoted as subject with disabilities or language problems. We failed to get questionares from them. There are 120 of them. They should be excluded.

* There are 3286 missing responses which need further revision.

```{r echo=FALSE}
bc_data_exc_aus %>% filter(is.na(diet_q_hi)) %>% 
  select(new_id,epi_q_breast,diet_q_hi,
                           calories_in_food,
                           satur_fat_in_food,monounsat_fat_in_food,
                           food_group_veg_exc_legumes,
                           food_group_potatoes_tubers,
                           total_grain,whole_grain,
                           food_group_all_fruits_inc_juice,
                           food_group_fruit_juice_only,
                           total_fruit,
                           food_group_nuts,
                           food_group_all_dairy,
                           alcohol_in_food,
                           food_group_redmeat_nonprocessed,
                           food_group_processed_redmeat,
                           food_group_poultry,
                           food_group_processed_poultry,
                           food_group_legumes,
                           fish_only)

```

After further check, although most of them do not have responses (NA), we do have their information of nutrients. We cannot exclude them directly.

Only exclude those with missing information in nutrient.

```{r echo=FALSE}
# extract id of those without missing info in nutrient variables
bc_data_dietq_na_id <- bc_data_exc_aus %>% filter(is.na(diet_q_hi)) %>% 
  select(new_id,calories_in_food,
         satur_fat_in_food,monounsat_fat_in_food,
         food_group_veg_exc_legumes,
         food_group_potatoes_tubers,
         total_grain,whole_grain,
         food_group_all_fruits_inc_juice,
         food_group_fruit_juice_only,
         total_fruit,food_group_nuts,
         food_group_all_dairy,
         alcohol_in_food,
         food_group_redmeat_nonprocessed,
         food_group_processed_redmeat,
         food_group_poultry,
         food_group_processed_poultry,
         food_group_legumes,fish_only) %>% 
  drop_na() %>% pull(new_id)

# see if there are missing info in nutrient variables
bc_data_exc_aus %>% filter(diet_q_hi==3) %>% 
  select(new_id,epi_q_breast,diet_q_hi,
                           calories_in_food,
                           satur_fat_in_food,monounsat_fat_in_food,
                           food_group_veg_exc_legumes,
                           food_group_potatoes_tubers,
                           total_grain,whole_grain,
                           food_group_all_fruits_inc_juice,
                           food_group_fruit_juice_only,
                           total_fruit,
                           food_group_nuts,
                           food_group_all_dairy,
                           alcohol_in_food,
                           food_group_redmeat_nonprocessed,
                           food_group_processed_redmeat,
                           food_group_poultry,
                           food_group_processed_poultry,
                           food_group_legumes,
                           fish_only) %>% 
  drop_na() %>% 
  dim() %>%
  .[1]

```

There won't be any na in id, epi questionnaire, and diet questionnaire variables, so we we can directly drop the na rows in the nutrient variable.

There are 11,900 rows after we drop rows with NA. 

There are 12,613 - 11,900 = 713 subjects with missing info in nutrient variables.

```{r}
# extract id of subjects who complete hawaii diet questionnaire without missing info of nutrient
bc_data_dietq3_id <- bc_data_exc_aus %>% filter(diet_q_hi==3) %>% 
  select(new_id,epi_q_breast,diet_q_hi,
                           calories_in_food,
                           satur_fat_in_food,monounsat_fat_in_food,
                           food_group_veg_exc_legumes,
                           food_group_potatoes_tubers,
                           total_grain,whole_grain,
                           food_group_all_fruits_inc_juice,
                           food_group_fruit_juice_only,
                           total_fruit,
                           food_group_nuts,
                           food_group_all_dairy,
                           alcohol_in_food,
                           food_group_redmeat_nonprocessed,
                           food_group_processed_redmeat,
                           food_group_poultry,
                           food_group_processed_poultry,
                           food_group_legumes,
                           fish_only) %>% 
  drop_na() %>% pull(new_id)

# use two id variables to get subjects who complete epi and diet questionnaires
bc_data_epi_diet_q <- bc_data_exc_aus %>% 
  filter(new_id %in% c(bc_data_dietq_na_id,bc_data_dietq3_id))

```

There are `r dim(bc_data_epi_diet_q)[1]` subjects left after we excluding subjects who didn't complete epi or diet questionnaire for different reasons.

Exclude the patients with abnormal energy intake. (> 4000 cal and <500 cal) 

```{r echo=FALSE}
bc_calories <- pull(bc_data_epi_diet_q,calories_in_food) 
bc_cal_cat <- rep(0, length(bc_calories))
for (i in 1:length(bc_cal_cat)) {
  if (bc_calories[i] < 500) {
    bc_cal_cat[i] = "0-499"
  } else if (bc_calories[i] >= 500 & bc_calories[i] < 1000) {
    bc_cal_cat[i] = "500-999"
  } else if (bc_calories[i] >= 1000 & bc_calories[i] < 1500) {
    bc_cal_cat[i] = "1000-1499"
  } else if (bc_calories[i] >= 1500 & bc_calories[i] < 2000) {
    bc_cal_cat[i] = "1500-1999"
  } else if (bc_calories[i] >= 2000 & bc_calories[i] < 2500) {
    bc_cal_cat[i] = "2000-2499"
  } else if (bc_calories[i] >= 2500 & bc_calories[i] < 3000) {
    bc_cal_cat[i] = "2500-2999"
  } else if (bc_calories[i] >= 3000 & bc_calories[i] < 3500) {
    bc_cal_cat[i] = "3000-3499"
  } else if (bc_calories[i] >= 3500 & bc_calories[i] <= 4000) {
    bc_cal_cat[i] = "3500-4000"
  } else {
    bc_cal_cat[i] = "4000+"
  }
}

bc_data_epi_diet_q <- bc_data_epi_diet_q %>% 
  add_column(bc_cal_cat,.after = "calories_in_food")

# create a table to see distribution
bc_data_epi_diet_q %>% group_by(bc_cal_cat) %>% 
  summarize(freq = n())

bc_data_epi_diet_q <- bc_data_epi_diet_q %>% 
  filter(bc_cal_cat!="0-499") %>% 
  filter(bc_cal_cat!="4000+")

```

Based on the table, there are 101 subjects with less than 500 cal and 722 subjects with greater than 4000 cal. 823 subjects should be removed from dataset.

There are 14142 subjects left in the dataset.

## Exclude patient who were diagnosed with breast cancer or had surgery of mastectomy before the date of interview.

### breast cancer diagnosis 

We can use the information from bc_rx and looked at the answer of those two questions. We will exclude patients who answered yes.

```{r echo=FALSE}
# there are some patients missed these two questions
# we only exclude people who answered yes
# brca: 2 was denoted as those who answered no
# 8 and 9 denoted not asked and missing
# see the distribution of brca
bc_data_epi_diet_q %>% group_by(brca) %>% 
  summarize(freq = n())


```

There are 5626 subjects who answered 'yes', 64 subjects answered 'no', and 8452 subjects with N/A. We cannot exclude those with N/A directly. We still need to check their date of diagnosis. Also, there could be recall bias happened. We need to check date of diagnosis for all of them.

To get the date of diagnosis, we need to get information from cancer.csv. Pick the patient with earliest date of breast cancer diagnosis.

```{r include=FALSE}
# diagnose date of breast cancer
# data is from cancer.csv
# some patients could get more than one tumor from multiple sites
# pick the patient with breast cancer
# see the distribution of cancer site
cancer %>% group_by(site) %>% 
  summarize(freq = n())

```

Based on ICD-O-3, we only choose the sites: C500-509.

```{r include=FALSE}
# select subjects with breast cancer
bc_cancer <- cancer %>% filter(site %in% c("C500","C501","C502","C503",
                              "C504","C505","C506","C507",
                              "C508","C509"))

# only use the earliest dxdate of breast cancer
dt_dx <- pull(bc_cancer,dxdate) %>% ymd() # convert into date format
# there are 1629 answers that cannot be converted into time formart
na_check <- which(is.na(dt_dx)) # get row number of missing date information

# create a table to see distribution
bc_cancer[na_check,] %>% 
  select(dxdate) %>% 
  group_by(dxdate) %>% 
  summarize(n=n())

```

The distribution of missing date is not good because there are so many missing month and day. We can eliminate the duplicated subjects by selecting the smallest dxdate and smallest age. For those with multiple tumor sites with equal diagnose date, only keep one of them. Some only have age at diagnosis without date and they have more than one tumor. Pick the smallest age at diagnosis. 

```{r include=FALSE}
# create a new dataset without duplicated subject id by picked smallest dxdate
bc_cancer_data_dx <- bc_cancer %>% 
  filter(center_no %in% c(1,2,3,5,6)) %>% 
  select(new_id,agedx,dxdate,dxest) %>% 
  group_by(new_id) %>% 
  mutate(min_dxAge = min(agedx),
         early_dxdate = min(dxdate),
         min_dxest = min(dxest)) %>% 
  filter(dxdate==early_dxdate) %>% 
  filter(agedx==min_dxAge) %>% 
  filter(dxest==min_dxest) %>% 
  distinct()
# we need to make sure if they have unique id
sum(duplicated(bc_cancer_data_dx[,1]))
# it's 0, which means there is no duplicated subjects
bc_cancer_data_dx <- select(bc_cancer_data_dx,-c(min_dxAge,early_dxdate,min_dxest))

# we can merge the cancer data with the data without breast cancer and mas
bc_data7 <- left_join(bc_data_epi_diet_q,bc_cancer_data_dx,by="new_id")

```

There are 14142 subjects in total.

We can use dxage and dxdate to detemine if the diagnosis date is before interview date. We need to remove subject with missing dxage and dxdate.

```{r echo=FALSE}
# remove missing
dx_NA_id <- bc_data7 %>% 
  filter(dxdate==99999999 & agedx==999) %>% 
  pull(new_id)
bc_id <- bc_data7 %>% pull(new_id)

id_loc <- rep(0,length(dx_NA_id)) # create a vector to show the location of id
for (i in 1:length(dx_NA_id)) {
  id_loc[i] <- which(bc_id==dx_NA_id[i])
}

bc_id <- bc_id[-id_loc]

bc_data7 <- bc_data7 %>% filter(new_id %in% bc_id)

```

There are 24 rows with missing dxdate and agedx. There isn't any rows with missing dt_interview and age_interview.

Next, we checked those subjects with missing dxdate but agedx. We can compare the age at interview and age at diagnosis. We will select patients with age of diagnosis that is greater than or equal to age at interview. (we are temporarily not sure what to do to deal with those with equal agedx.) 

```{r include=FALSE}
# create a new variable with subject id who have missing diagnosis date
# but agedx is greater than or equal to age at interview
bc_int_bf_dx_missdate_id <- bc_data7 %>% 
  filter(dxdate==99999999) %>% 
  select(new_id,dt_interview,age_interview,agedx,dxdate) %>% 
  filter(agedx>age_interview) %>% pull(new_id)

```

There are `r length(bc_int_bf_dx_missdate_id)` subjects with missing dxdate but greater or equal agedx (compared with age at interview).

We next check patients with N/A dxdate and see how agedx change and we are sure that patients with NA dxdate all have NA agedx.

```{r include=FALSE}
# see total length of agedx
bc_data7 %>% filter(is.na(dxdate)) %>% 
  select(new_id,dt_interview,age_interview,age_interview,agedx,dxdate) %>% 
  pull(agedx) %>% length()

# see how many NA in agedx
bc_data7 %>% filter(is.na(dxdate)) %>% 
  select(new_id,dt_interview,age_interview,age_interview,agedx,dxdate) %>% 
  pull(agedx) %>% is.na() %>% sum()

# we need id for those with NA dxdate and dxage
bc_dx_int_NA_agedxdate_id <- bc_data7 %>% filter(is.na(dxdate)) %>% pull(new_id)

```

There are `r length(bc_dx_int_NA_agedxdate_id)` subjects with N/A dxdate and agedx.

We next check patient with dxdata information. We first compare agedx and age_interview.

```{r include=FALSE}
# exclude missing dxdate and N/A dxdate 
bc_dx_int <- bc_data7 %>% filter(dxdate!=99999999) %>% 
  filter(!is.na(dxdate)) %>% 
  select(new_id,dt_interview,age_interview,agedx,dxdate)

```

Except NA and missing dxdate, there are 7,518 subjects with dxdate info.

We can compared the agedx and age_interview directly as other research did. We first need to check if there are any missing age_interview and agedx.

```{r echo=FALSE}
# check if there are missing in agedx and age_interview
bc_dx_int %>% filter(age_interview==999|agedx==999)

```

There are 4 subjects with missing agedx. We can compare the dxdate alternatively. We next seet how many subjects have equal agedx and age_interview. 

```{r include=FALSE}
bc_dx_int %>% filter(age_interview==agedx)


```

There are 306 subjects with equal agedx and age at interview. For those subjects, we also need to compare the dxdate and dt_interview alternatively.

For other subjects, we can compare the age directly. 

```{r include=FALSE}
# create a new variable for subject id who agedx is greater than age_interview
bc_int_bf_dx_id <- bc_dx_int %>% filter(agedx!=999) %>% 
  filter(age_interview < agedx) %>% pull(new_id)


```

There are `r length(bc_int_bf_dx_id)` subjects with agedx greater than age_interview.

For those with miss dxage or equal dxage and age_interview, we need to compare the dt_interview and dxdate.

```{r}
# extract interview date and convert to date format
date_int <- bc_dx_int %>% filter(agedx==age_interview | agedx==999) %>% 
  pull(dt_interview) %>% ymd()
# create a new variable for year of interview
date_int_yr <- year(date_int)
# create a new variable month of interview
date_int_mth <- month(date_int)

# we also need the time point 'two months after diagnosis'
# b/c subjects diagnosed within two months after interview should be excluded
# there are problems of adding 2 months directly
# b/c 12 months have different number of days
# we choose to add 61 days (30.5 days / month)
date_int_two_mth <- date_int + ddays(61)

#########################################################################

# create a new variable for dxdate
# extract diagnosis date and convert it into date format
date_dx <- bc_dx_int %>% 
  filter(agedx==age_interview | agedx==999) %>%
  pull(dxdate) %>% 
  ymd()
# there are 15 failed to parse
# get the location of NA
# generate a new varaible for those NA's location
date_dx_na_loc <- which(is.na(date_dx))

# view the date
bc_dx_int %>% 
  filter(agedx==age_interview | agedx==999) %>% 
  pull(dxdate) %>%
  .[date_dx_na_loc]

# create a variable year of diagnosis
date_dx_yr <- year(date_dx)  
# it was formed by those who are successfully converted into date format
# create a new variable for month of diagnosis
date_dx_mth <- month(date_dx)

# we need to fill value of year and month separately for those with missing month and day
# generate a new variable year of diagnosis for those missing month and day
date_dx_miss_yr <- bc_dx_int %>% 
  filter(agedx==age_interview | agedx==999) %>% 
  pull(dxdate) %>%
  .[date_dx_na_loc] %>% 
  as.character() %>% 
  substr(.,start = 1,stop = 4) %>% 
  as.numeric()

# generate a new variable month of diagnosis for those missing month and day
date_dx_miss_mth <- bc_dx_int %>% 
  filter(agedx==age_interview | agedx==999) %>% 
  pull(dxdate) %>%
  .[date_dx_na_loc] %>% 
  as.character() %>% 
  substr(.,start = 5,stop = 6) %>% 
  as.numeric()
# there are lots of 99 in months
# b/c some patients do not have info on months
# to avoid error in comparation, change 99 to 6 (June)
date_dx_miss_mth[which(date_dx_miss_mth==99)] <- 6

# fill in the value into variable year of diagnosis
for (i in 1:length(date_dx_na_loc)) {
    date_dx_yr[date_dx_na_loc[i]] <- date_dx_miss_yr[i]
    date_dx_mth[date_dx_na_loc[i]] <- date_dx_miss_mth[i]
}

# create a new tibble for subjects with missing agedx and equal agedx and age_interview
bc_dx_int_tbl <- bc_dx_int %>% 
  filter(agedx==age_interview | agedx==999)

# add those variables in date format to bc_dx_int
bc_dx_int_tbl <- add_column(bc_dx_int_tbl,
                        date_int,date_int_yr,date_int_mth,date_int_two_mth,
                        .after = "dt_interview") %>% 
  add_column(.,
             date_dx,date_dx_yr,date_dx_mth,
             .after = "dxdate")

```

We already converted these data into date format or separated them apart into year and month. Next, we are going to filter the data by date, year, and month. 

New variables, being used to determine if diagnose date is before interview date, are created and added into the tibble. The table of distribution will be created as well. 

We will use 1 to denote patients whose diagnosed date is before or equal to interview date. Those patient will be excluded; we will use 0 to denote patient who diagnosed date is after interview date.

* filtered by exact date

```{r echo=FALSE}
# see the distribution of subjects whose dxdate is before or equal to date of interview
bc_dx_int_tbl %>% mutate(dx_bf_int_2mth = case_when(
  date_int_two_mth < date_dx ~ 0,
  date_int_two_mth >= date_dx ~ 1)) %>% 
  group_by(dx_bf_int_2mth) %>% 
  summarize(n=n()) 

# based on the output, the column in date format can be more accurate
# redefine the tibble
bc_dx_int_tbl <- bc_dx_int_tbl %>% mutate(dx_bf_int_2mth = case_when(
  date_int_two_mth < date_dx ~ 0,
  date_int_two_mth >= date_dx ~ 1))

```

Among 310 subjects with missing agedx or equal agedx and age_interview, there are 18 subjects with daignosed date after interview date (+2 months), 277 subjects with diagnosis date before or equal to interview date (+2 months), and 15 subjects with NA. The NA is caused by missing value in month and day.

For those who missed information on month and day, we can looked at year alternatively.

* filtered by year

We used 1 to denote those who have equal interview and diagnosis year; 0 denoted those with unequal year of interview and diagnosis.

```{r echo=FALSE}
# see the distribution of subjects with missing in month and day but with equal year
bc_dx_int_tbl %>% filter(is.na(dx_bf_int_2mth)) %>%  
  mutate(dx_eql_int_yr = case_when(
  date_int_yr == date_dx_yr ~ 1,
  date_int_yr != date_dx_yr ~ 0)) %>% 
  group_by(dx_eql_int_yr) %>% 
  summarize(n=n())

```

There are 6 subjects with equal year of dx and interview and 9 subjects with unequal year of dx and interview.

```{r echo=FALSE}
# see the distribution of subjects without missing month and day
bc_dx_int_tbl %>% filter(is.na(dx_bf_int_2mth)) %>%  
  mutate(dx_bf_int_yr = case_when(
  date_int_yr > date_dx_yr ~ 1,
  date_int_yr < date_dx_yr ~ 0)) %>% 
  group_by(dx_bf_int_yr) %>% 
  summarize(n=n())

```

There is only 1 subject with smaller interview year; there are 8 subjects with greater interview year. 

```{r include=FALSE}
# add new variable indicated if year of dx is smaller than year of interview
bc_dx_int_tbl <- bc_dx_int_tbl %>% 
  mutate(dx_eql_int_yr = case_when(
    date_int_yr == date_dx_yr ~ 1,
    date_int_yr != date_dx_yr ~ 0),
    dx_bf_int_yr = case_when(
      date_int_yr > date_dx_yr ~ 1,
      date_int_yr < date_dx_yr ~ 0
  ))

```


* filter by month for subjects with equal years of interview and diagnosis

Month will indicate if their diagnosis dates are before two months after interview date, because we don't need any subjects who were diagnosed within 2 months after interview date.

We still need to see if there are subjects with equal years and months of interview (+2 months) and diagnosis. If so, we may ask for further information from data source. 

```{r echo=FALSE}
# view how many subjects have equal year and equal month
bc_dx_int_tbl %>% filter(is.na(dx_bf_int_2mth)) %>% 
  filter(dx_eql_int_yr==1) %>% 
  mutate(dx_eql_int_yr_mth = case_when(
    date_int_mth+2 == date_dx_mth ~ 1,
    date_int_mth+2 != date_dx_mth ~ 0
  )) %>% group_by(dx_eql_int_yr_mth) %>% 
  summarize(n=n())
         
```

There is no subject with equal years and equal months of interview (+2 months) and diagnosis.

Since there is no equal months of diagnosis and interview (+2 months), we can only include 'greater than' and 'smaller than' symbols in the code.

There may be concerns about months because values of months can go over 12. However, if the months of interview (+2 months) go over 12, it indicated that the year of interview of this subject can be greater than the year of diagnosis. They will be denoted as 1 and be excluded. Therefore, no futher actions are needed.  

```{r echo=FALSE}
bc_dx_int_tbl %>% filter(is.na(dx_bf_int_2mth)) %>% 
  filter(dx_eql_int_yr==1) %>% 
  mutate(dx_bf_int_yr_mth = case_when(
    date_int_mth+2 > date_dx_mth ~ 1,
    date_int_mth+2 < date_dx_mth ~ 0
  )) %>% group_by(dx_bf_int_yr_mth) %>% 
  summarize(n=n())

```

There are 2 subjects with equal years whose diagnosis months is later than interview months (+2 months).

There are 4 subjects with equal years whose diagnosis months is earlier than interview months (+2 months).

```{r echo=FALSE}
# create a new variable for comparing months
bc_dx_int_tbl <- bc_dx_int_tbl %>% mutate(dx_bf_int_yr_mth = case_when(
  date_int_mth+2 > date_dx_mth ~ 1,
  date_int_mth+2 < date_dx_mth ~ 0
  ))

```

use the indicator variable we built before to exclude those before interview date and 2 months before interview date.

```{r}
# we only need new_id b/c we can use it to select the row from the whole dataset
# create a new variable for id of subjects with exact date whose diagnosis date is after interview date (+2 months)
bc_int_bf_dx_id1 <- bc_dx_int_tbl %>% 
  filter(dx_bf_int_2mth==0) %>% 
  pull(new_id)

# create a new variable for id of subjects without exact date whose diagnosis year is after interview year
bc_int_bf_dx_id2 <- bc_dx_int_tbl %>% 
  filter(is.na(dx_bf_int_2mth)) %>% 
  filter(dx_eql_int_yr==0) %>% 
  filter(dx_bf_int_yr==0) %>% 
  pull(new_id)

# create a new variable for id of subjects without exact date whose diagnosis month is after interview month +2, given year are equal 
bc_int_bf_dx_id3 <- bc_dx_int_tbl %>% 
  filter(is.na(dx_bf_int_2mth)) %>% 
  filter(dx_eql_int_yr==1) %>% 
  filter(dx_bf_int_yr_mth==0) %>% 
  pull(new_id)
  
# combine all subjects with date infomation whose diagnosis date is at least two months after interview date
bc_data7_id <- c(bc_int_bf_dx_missdate_id,
                 bc_dx_int_NA_agedxdate_id,
                 bc_int_bf_dx_id,
                 bc_int_bf_dx_id1,
                 bc_int_bf_dx_id2,
                 bc_int_bf_dx_id3)

# get the number of subjects with date infomation whose diagnosis date is at least two months after interview date
length(bc_data7_id)

# renew the bc_data7
bc_data7 <- bc_data7 %>% 
  filter(new_id %in% bc_data7_id)

```

There are 7,012 subject left in the dataset.

### mastectomy

Similar with breast cancer diagnosis, we check answers to the question of mastectomy first.

```{r}
# view the distribution of subjects who answered question of mastectomy
bc_data7_exc_dx %>% group_by(br_surg_mas) %>% 
  summarize(n=n())

```

"1" was denoted as subjects who answered "yes" in the question; "2" was denoted as subjects who answered "no" in the question. 

There are 2 subject who answered "yes" at the baseline. 

There are 12 subjects who answered "no" at the baseline.

There are 6676 subjects with NA.

We cannot directly remove subjects who answered "yes" before we check if they removed both sides of breast.

```{r}



```






